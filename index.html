<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 2.5 Live | اتصال مباشر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #020617; color: white; }
        .visualizer { display: flex; align-items: center; justify-content: center; gap: 4px; height: 80px; }
        .bar { width: 8px; background: #6366f1; border-radius: 99px; height: 10%; transition: height 0.05s ease; }
        .glow { box-shadow: 0 0 15px rgba(99, 102, 241, 0.5); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

<div class="w-full max-w-md bg-slate-900 border border-slate-700 rounded-3xl p-8 shadow-2xl relative overflow-hidden">
    
    <!-- Header -->
    <div class="text-center mb-8 relative z-10">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-700 text-xs text-indigo-400 font-mono mb-4">
            <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
            models/gemini-2.5-flash-native-audio-dialog
        </div>
        <h1 class="text-2xl font-bold">محادثة حية</h1>
    </div>

    <!-- Active Call UI -->
    <div id="activeCallUI" class="hidden flex-col items-center justify-center space-y-8">
        <div class="relative w-32 h-32 flex items-center justify-center">
            <div class="absolute inset-0 bg-indigo-500/20 rounded-full animate-ping"></div>
            <div class="w-28 h-28 bg-slate-800 rounded-full flex items-center justify-center border-2 border-indigo-500 z-10 glow">
                <i data-lucide="mic" class="w-12 h-12 text-white"></i>
            </div>
        </div>
        
        <div class="visualizer w-full" id="visualizer">
            <!-- Bars will be injected -->
        </div>

        <button onclick="disconnect()" class="bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20 w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
            <i data-lucide="phone-off"></i> إنهاء الاتصال
        </button>
    </div>

    <!-- Setup UI -->
    <div id="setupUI" class="space-y-6">
        <div class="space-y-2">
            <label class="text-sm text-slate-400 font-bold">مفتاح API الخاص بك</label>
            <input type="password" id="apiKey" placeholder="AIzaSy..." class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-center text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
        </div>

        <button onclick="connect()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-600/20 transition-all flex items-center justify-center gap-2">
            <i data-lucide="zap"></i> بدء المحادثة
        </button>

        <div id="logs" class="text-xs text-center text-slate-500 font-mono h-6">...</div>
    </div>

</div>

<script>
    lucide.createIcons();
    const visualizer = document.getElementById('visualizer');
    for(let i=0; i<20; i++) {
        const bar = document.createElement('div');
        bar.className = 'bar';
        visualizer.appendChild(bar);
    }
    const bars = document.querySelectorAll('.bar');

    // --- Configuration ---
    const MODEL_NAME = "models/gemini-2.5-flash-native-audio-dialog"; // YOUR SPECIFIC MODEL
    const SAMPLE_RATE = 24000; // Gemini Native Audio requirement

    let audioContext;
    let ws;
    let stream;
    let processor;
    let inputSource;
    let isConnected = false;

    async function connect() {
        const key = document.getElementById('apiKey').value;
        if(!key) return log("الرجاء إدخال المفتاح", true);

        log("جاري طلب صلاحية المايك...");

        try {
            // 1. Audio Context
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
            
            // 2. Stream
            stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { 
                    channelCount: 1, 
                    sampleRate: SAMPLE_RATE,
                    echoCancellation: true 
                } 
            });

            // 3. WebSocket
            const url = `wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${key}`;
            log("جاري الاتصال بالسيرفر...");
            
            ws = new WebSocket(url);

            ws.onopen = () => {
                log("تم الاتصال! جاري إرسال الإعدادات...");
                
                // --- THE CRITICAL PART: SENDING YOUR SPECIFIC MODEL ---
                const setupMsg = {
                    setup: {
                        model: MODEL_NAME,
                        generation_config: { response_modalities: ["AUDIO"] }
                    }
                };
                ws.send(JSON.stringify(setupMsg));
                
                startStreaming();
                toggleUI(true);
            };

            ws.onmessage = async (evt) => {
                if (evt.data instanceof Blob) {
                    playAudioChunk(await evt.data.arrayBuffer());
                } else {
                    const msg = JSON.parse(evt.data);
                    // Handle Text Control Messages if needed
                    if (msg.serverContent?.modelTurn?.parts) {
                        msg.serverContent.modelTurn.parts.forEach(p => {
                            if(p.inlineData) playPcm(p.inlineData.data);
                        });
                    }
                }
            };

            ws.onerror = (e) => {
                console.error(e);
                log("خطأ في الاتصال (تأكد من اسم الموديل والمفتاح)", true);
                disconnect();
            };

            ws.onclose = (e) => {
                if (e.code !== 1000) log(`انقطع الاتصال (Code: ${e.code})`, true);
                disconnect();
            };

        } catch (err) {
            log("خطأ: " + err.message, true);
        }
    }

    function startStreaming() {
        inputSource = audioContext.createMediaStreamSource(stream);
        processor = audioContext.createScriptProcessor(4096, 1, 1);
        inputSource.connect(processor);
        processor.connect(audioContext.destination);

        processor.onaudioprocess = (e) => {
            if (ws.readyState !== WebSocket.OPEN) return;

            const inputData = e.inputBuffer.getChannelData(0);
            
            // Downsample if necessary (browser safeguard)
            const downsampled = downsampleBuffer(inputData, audioContext.sampleRate, SAMPLE_RATE);
            const pcm16 = floatTo16BitPCM(downsampled);
            const base64 = arrayBufferToBase64(pcm16);

            const msg = {
                realtime_input: {
                    media_chunks: [{
                        mime_type: "audio/pcm",
                        data: base64
                    }]
                }
            };
            ws.send(JSON.stringify(msg));
            animateVisualizer(true);
        };
    }

    // --- Helpers ---
    function floatTo16BitPCM(input) {
        const output = new Int16Array(input.length);
        for (let i = 0; i < input.length; i++) {
            const s = Math.max(-1, Math.min(1, input[i]));
            output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return output.buffer;
    }

    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
        return window.btoa(binary);
    }

    function downsampleBuffer(buffer, sampleRate, outSampleRate) {
        if (outSampleRate === sampleRate) return buffer;
        if (outSampleRate > sampleRate) return buffer;
        const sampleRateRatio = sampleRate / outSampleRate;
        const newLength = Math.round(buffer.length / sampleRateRatio);
        const result = new Float32Array(newLength);
        let offsetResult = 0;
        let offsetBuffer = 0;
        while (offsetResult < result.length) {
            const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
            let accum = 0, count = 0;
            for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                accum += buffer[i];
                count++;
            }
            result[offsetResult] = accum / count;
            offsetResult++;
            offsetBuffer = nextOffsetBuffer;
        }
        return result;
    }

    function playPcm(base64) {
        const binary = window.atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        const int16 = new Int16Array(bytes.buffer);
        const float32 = new Float32Array(int16.length);
        for(let i=0; i<int16.length; i++) float32[i] = int16[i] / 32768.0;
        
        const buffer = audioContext.createBuffer(1, float32.length, SAMPLE_RATE);
        buffer.getChannelData(0).set(float32);
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);
        animateVisualizer(false);
    }

    // --- UI ---
    function toggleUI(active) {
        if(active) {
            document.getElementById('setupUI').classList.add('hidden');
            document.getElementById('activeCallUI').classList.remove('hidden');
            document.getElementById('activeCallUI').classList.add('flex');
        } else {
            document.getElementById('setupUI').classList.remove('hidden');
            document.getElementById('activeCallUI').classList.add('hidden');
            document.getElementById('activeCallUI').classList.remove('flex');
        }
    }

    function disconnect() {
        if(ws) ws.close();
        if(stream) stream.getTracks().forEach(t => t.stop());
        if(audioContext) audioContext.close();
        toggleUI(false);
        log("انتهى الاتصال");
    }

    function log(msg, isError = false) {
        const el = document.getElementById('logs');
        el.innerText = msg;
        el.className = isError ? "text-xs text-center text-red-400 font-bold" : "text-xs text-center text-slate-500 font-mono";
    }

    function animateVisualizer(isInput) {
        bars.forEach(bar => {
            bar.style.height = `${Math.random() * 100}%`;
            bar.style.background = isInput ? '#6366f1' : '#a855f7';
        });
        setTimeout(() => bars.forEach(b => b.style.height = '10%'), 150);
    }
</script>

</body>
</html>