<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Live Audio | محادثة صوتية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0f172a; color: white; }
        .visualizer-container { height: 100px; display: flex; align-items: center; justify-content: center; gap: 3px; }
        .bar { width: 6px; background: #6366f1; border-radius: 99px; transition: height 0.1s; height: 10px; }
        .glow-active { box-shadow: 0 0 20px rgba(99, 102, 241, 0.6); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Card -->
    <div class="w-full max-w-md bg-slate-900 border border-slate-700 rounded-3xl p-8 shadow-2xl relative overflow-hidden">
        
        <!-- Decoration -->
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>

        <!-- Header -->
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-slate-800 rounded-full mx-auto flex items-center justify-center mb-4 relative group">
                <div id="statusIndicator" class="absolute inset-0 rounded-full border-2 border-slate-600 transition-all duration-500"></div>
                <i data-lucide="mic" class="w-8 h-8 text-slate-400 transition-colors" id="micIcon"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-1">Gemini Live</h1>
            <p class="text-slate-400 text-sm" id="statusText">جاهز للاتصال</p>
        </div>

        <!-- Audio Visualizer -->
        <div class="visualizer-container mb-8" id="visualizer">
            <!-- Bars will be generated by JS -->
        </div>

        <!-- Controls -->
        <div class="space-y-4">
            <!-- API Key Input -->
            <div id="setupStep" class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-500 mb-2 font-bold">مفتاح API (يتطلب نموذج Gemini 2.0 Flash)</label>
                    <input type="password" id="apiKey" placeholder="ضع مفتاح جوجل هنا..." 
                        class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-indigo-500 transition-colors text-center"
                    >
                </div>
                <button onclick="startSession()" 
                    class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg shadow-indigo-900/50">
                    <i data-lucide="zap"></i> بدء المحادثة الحية
                </button>
            </div>

            <!-- Active Call Controls (Hidden Initially) -->
            <div id="callControls" class="hidden grid-cols-2 gap-4">
                <button onclick="toggleMic()" id="muteBtn" class="bg-slate-800 hover:bg-slate-700 text-white py-4 rounded-xl flex flex-col items-center justify-center gap-2 transition-all">
                    <i data-lucide="mic"></i> <span class="text-xs">كتم الصوت</span>
                </button>
                <button onclick="endSession()" class="bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20 py-4 rounded-xl flex flex-col items-center justify-center gap-2 transition-all">
                    <i data-lucide="phone-off"></i> <span class="text-xs">إنهاء</span>
                </button>
            </div>
        </div>

        <!-- Log Area (Optional) -->
        <div id="logs" class="mt-6 text-center text-xs text-slate-600 h-6 overflow-hidden">
            انتظار الإدخال...
        </div>
    </div>

    <script>
        // --- تهيئة الأيقونات ---
        lucide.createIcons();

        // --- إعدادات الصوت والشبكة ---
        let audioContext;
        let ws;
        let stream;
        let processor;
        let inputSource;
        let isMuted = false;
        let isConnected = false;
        
        // إعدادات نموذج جوجل (معدل أخذ العينات المطلوب)
        const GOOGLE_SAMPLE_RATE = 24000; 

        // --- بناء الفيجوالايزر ---
        const visualizer = document.getElementById('visualizer');
        const bars = [];
        for(let i=0; i<20; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            visualizer.appendChild(bar);
            bars.push(bar);
        }

        function log(msg) {
            document.getElementById('logs').innerText = msg;
        }

        // --- 1. بدء الجلسة والتعامل مع أذونات المتصفح ---
        async function startSession() {
            const key = document.getElementById('apiKey').value;
            if (!key) { alert("من فضلك أدخل مفتاح API"); return; }

            // تفعيل واجهة الاتصال
            document.getElementById('setupStep').classList.add('hidden');
            document.getElementById('callControls').classList.remove('hidden');
            document.getElementById('callControls').classList.add('grid');
            updateStatus('connecting');

            try {
                // 1. تشغيل AudioContext (يجب أن يتم بضغطة زر لتجنب حظر المتصفح)
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: GOOGLE_SAMPLE_RATE });
                await audioContext.resume();

                // 2. طلب إذن المايكروفون
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        channelCount: 1, 
                        sampleRate: GOOGLE_SAMPLE_RATE,
                        echoCancellation: true 
                    } 
                });

                // 3. فتح اتصال WebSocket مع جوجل
                const url = `wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${key}`;
                ws = new WebSocket(url);

                ws.onopen = () => {
                    log("تم الاتصال بالسيرفر");
                    updateStatus('connected');
                    isConnected = true;
                    
                    // إرسال رسالة الإعداد (Setup Message)
                    const setupMsg = {
                        setup: {
                            model: "models/gemini-2.0-flash-exp", // هذا هو النموذج الذي يدعم الصوت الحي حالياً
                            generation_config: { response_modalities: ["AUDIO"] }
                        }
                    };
                    ws.send(JSON.stringify(setupMsg));

                    // بدء تسجيل وإرسال الصوت
                    startAudioRecorder();
                };

                ws.onmessage = async (event) => {
                    if (event.data instanceof Blob) {
                        // استلام صوت (Blob)
                        const arrayBuffer = await event.data.arrayBuffer();
                        playAudioChunk(arrayBuffer);
                    } else {
                        // استلام نص (JSON)
                        const msg = JSON.parse(event.data);
                        if (msg.serverContent && msg.serverContent.modelTurn) {
                            const parts = msg.serverContent.modelTurn.parts;
                            for (const part of parts) {
                                if (part.inlineData) {
                                    // تحويل Base64 إلى صوت وتشغيله
                                    const pcmData = base64ToFloat32(part.inlineData.data);
                                    playPcmAudio(pcmData);
                                    animateVisualizer(true);
                                }
                            }
                        }
                    }
                };

                ws.onclose = () => endSession();
                ws.onerror = (err) => { console.error(err); log("حدث خطأ في الاتصال"); };

            } catch (error) {
                console.error(error);
                alert("فشل الوصول للمايكروفون أو الاتصال: " + error.message);
                endSession();
            }
        }

        // --- 2. تسجيل وإرسال الصوت (Recorder) ---
        function startAudioRecorder() {
            inputSource = audioContext.createMediaStreamSource(stream);
            
            // استخدام ScriptProcessor (طريقة كلاسيكية تعمل في ملف واحد بدون Worklet خارجي)
            processor = audioContext.createScriptProcessor(4096, 1, 1);

            inputSource.connect(processor);
            processor.connect(audioContext.destination);

            processor.onaudioprocess = (e) => {
                if (isMuted || !isConnected) return;

                const inputData = e.inputBuffer.getChannelData(0);
                
                // تحويل الصوت إلى PCM 16-bit وارسال Base64
                // نحتاج لعمل Downsampling إذا كان تردد الجهاز مختلفاً، لكننا طلبنا 24000 في البداية
                const pcm16 = floatTo16BitPCM(inputData);
                const base64 = arrayBufferToBase64(pcm16);

                // إرسال للجيمناي
                const msg = {
                    realtime_input: {
                        media_chunks: [{
                            mime_type: "audio/pcm",
                            data: base64
                        }]
                    }
                };
                
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(msg));
                    animateVisualizer(false); // تحريك البارات بناء على صوتي
                }
            };
        }

        // --- 3. تشغيل الصوت القادم (Player) ---
        function playPcmAudio(pcmData) {
            // إنشاء AudioBuffer
            const buffer = audioContext.createBuffer(1, pcmData.length, GOOGLE_SAMPLE_RATE);
            buffer.getChannelData(0).set(pcmData);

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);
        }

        // --- أدوات مساعدة للتحويل (Helpers) ---
        function floatTo16BitPCM(input) {
            const output = new Int16Array(input.length);
            for (let i = 0; i < input.length; i++) {
                const s = Math.max(-1, Math.min(1, input[i]));
                output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return output.buffer;
        }

        function base64ToFloat32(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            
            // تحويل من Int16 إلى Float32
            const int16 = new Int16Array(bytes.buffer);
            const float32 = new Float32Array(int16.length);
            for (let i = 0; i < int16.length; i++) {
                float32[i] = int16[i] / 32768.0;
            }
            return float32;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // --- التحكم في الواجهة ---
        function toggleMic() {
            isMuted = !isMuted;
            const btn = document.getElementById('muteBtn');
            const icon = document.getElementById('micIcon');
            
            if (isMuted) {
                btn.classList.add('bg-red-500', 'text-white');
                btn.classList.remove('bg-slate-800');
                btn.innerHTML = `<i data-lucide="mic-off"></i> <span class="text-xs">مكتوم</span>`;
                icon.classList.add('text-red-500');
                log("المايكروفون مكتوم");
            } else {
                btn.classList.remove('bg-red-500', 'text-white');
                btn.classList.add('bg-slate-800');
                btn.innerHTML = `<i data-lucide="mic"></i> <span class="text-xs">كتم الصوت</span>`;
                icon.classList.remove('text-red-500');
                log("المايكروفون يعمل");
            }
            lucide.createIcons();
        }

        function endSession() {
            if (ws) ws.close();
            if (stream) stream.getTracks().forEach(track => track.stop());
            if (processor) processor.disconnect();
            if (inputSource) inputSource.disconnect();
            
            isConnected = false;
            document.getElementById('setupStep').classList.remove('hidden');
            document.getElementById('callControls').classList.add('hidden');
            document.getElementById('callControls').classList.remove('grid');
            updateStatus('disconnected');
            log("انتهت الجلسة");
        }

        function updateStatus(state) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const icon = document.getElementById('micIcon');

            if (state === 'connecting') {
                indicator.className = "absolute inset-0 rounded-full border-4 border-yellow-500 border-t-transparent animate-spin";
                text.innerText = "جاري الاتصال...";
            } else if (state === 'connected') {
                indicator.className = "absolute inset-0 rounded-full border-2 border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.5)]";
                text.innerText = "متصل (تحدث الآن)";
                icon.classList.add('text-white');
            } else {
                indicator.className = "absolute inset-0 rounded-full border-2 border-slate-600";
                text.innerText = "منقطع";
                icon.classList.remove('text-white');
            }
        }

        function animateVisualizer(isAI) {
            // محاكاة بسيطة للحركة لعدم تعقيد الكود بمحلل ترددات حقيقي
            bars.forEach(bar => {
                const height = Math.random() * 40 + 10;
                bar.style.height = `${height}px`;
                bar.style.background = isAI ? '#a855f7' : '#6366f1'; // لون مختلف للذكاء الاصطناعي
            });
        }

        // Animation Loop Reset
        setInterval(() => {
            if (!isConnected) {
                bars.forEach(bar => bar.style.height = '6px');
            }
        }, 100);

    </script>
</body>
</html>
