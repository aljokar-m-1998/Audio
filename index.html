<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Live | V2 Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0f172a; color: white; }
        .visualizer { display: flex; align-items: center; justify-content: center; gap: 4px; height: 60px; }
        .bar { width: 6px; background: #4f46e5; border-radius: 4px; height: 10%; transition: height 0.1s ease; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-md bg-slate-900 border border-slate-700 rounded-3xl p-6 shadow-2xl relative">
    
    <!-- Status Dot -->
    <div class="absolute top-4 left-4 flex items-center gap-2">
        <div id="statusDot" class="w-3 h-3 rounded-full bg-red-500"></div>
        <span id="statusText" class="text-xs text-slate-400">غير متصل</span>
    </div>

    <!-- Main Visual -->
    <div class="text-center mt-8 mb-8">
        <div class="w-24 h-24 bg-slate-800 rounded-full mx-auto flex items-center justify-center relative mb-4 border border-slate-700">
            <i data-lucide="mic" id="mainIcon" class="w-10 h-10 text-slate-500 transition-colors"></i>
            <div id="pulseRing" class="absolute inset-0 rounded-full border-2 border-indigo-500 opacity-0 transition-opacity"></div>
        </div>
        
        <!-- Visualizer -->
        <div class="visualizer" id="visualizer">
            <!-- Bars injected by JS -->
        </div>
    </div>

    <!-- Inputs -->
    <div id="setupPanel" class="space-y-4">
        <input type="password" id="apiKey" placeholder="ضع مفتاح API هنا..." class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-center text-white focus:border-indigo-500 outline-none">
        <button onclick="connectToGemini()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg flex justify-center gap-2">
            <i data-lucide="zap"></i> اتصال
        </button>
        <p class="text-[10px] text-center text-slate-500">ملاحظة: يجب تشغيل هذا الملف عبر سيرفر محلي (localhost) أو HTTPS ليعمل المايكروفون.</p>
    </div>

    <!-- Controls (Hidden) -->
    <div id="controlPanel" class="hidden grid-cols-1 gap-4">
        <button onclick="disconnect()" class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30 py-3 rounded-xl font-bold">
            إنهاء المحادثة
        </button>
    </div>

    <div id="errorLog" class="mt-4 text-xs text-red-400 text-center min-h-[20px]"></div>
</div>

<script>
    lucide.createIcons();
    const visualizer = document.getElementById('visualizer');
    // Create bars
    for(let i=0; i<15; i++) {
        const d = document.createElement('div');
        d.className = 'bar';
        visualizer.appendChild(d);
    }
    const bars = document.querySelectorAll('.bar');

    let audioContext;
    let ws;
    let stream;
    let processor;
    let inputSource;
    let isConnected = false;
    
    // Gemini 2.0 Live requires exactly 24kHz
    const TARGET_SAMPLE_RATE = 24000; 

    async function connectToGemini() {
        const key = document.getElementById('apiKey').value;
        if(!key) return showError("مطلوب مفتاح API");

        showError(""); // Clear errors
        setStatus('connecting');

        try {
            // 1. Initialize Audio Context (Standard, let browser decide rate)
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // 2. Get Mic Stream
            stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });

            // 3. Connect WebSocket
            // Note: Updated URL for Gemini 2.0 Flash Exp
            const url = `wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${key}`;
            ws = new WebSocket(url);

            ws.onopen = () => {
                setStatus('connected');
                // Send Initial Setup Message
                const setupMsg = {
                    setup: {
                        model: "models/gemini-2.0-flash-exp",
                        generation_config: { response_modalities: ["AUDIO"] }
                    }
                };
                ws.send(JSON.stringify(setupMsg));
                
                // Start recording
                startAudioProcessing();
            };

            ws.onmessage = async (evt) => {
                if (evt.data instanceof Blob) {
                    playAudioResponse(await evt.data.arrayBuffer());
                } else {
                    const msg = JSON.parse(evt.data);
                    if (msg.serverContent?.modelTurn?.parts) {
                        const parts = msg.serverContent.modelTurn.parts;
                        for (let p of parts) {
                            if (p.inlineData) {
                                // Convert raw PCM to float32 and play
                                playPcmData(p.inlineData.data);
                            }
                        }
                    }
                }
            };

            ws.onclose = (e) => {
                console.log("Closed:", e);
                disconnect();
                if(e.code !== 1000) showError("انقطع الاتصال: تأكد من المفتاح وصلاحيات الموديل");
            };

            ws.onerror = (e) => {
                console.error(e);
                showError("خطأ في الشبكة");
            };

        } catch (err) {
            console.error(err);
            showError("فشل الوصول للمايكروفون. هل تستخدم HTTPS؟");
            disconnect();
        }
    }

    function startAudioProcessing() {
        inputSource = audioContext.createMediaStreamSource(stream);
        // Using ScriptProcessor for compatibility
        processor = audioContext.createScriptProcessor(4096, 1, 1);

        inputSource.connect(processor);
        processor.connect(audioContext.destination);

        processor.onaudioprocess = (e) => {
            if (!isConnected) return;

            const inputData = e.inputBuffer.getChannelData(0);
            
            // --- CRITICAL FIX: DOWNSAMPLE TO 24kHz ---
            // Browsers often use 44.1k or 48k. Gemini REJECTS this.
            // We must manually convert to 24k.
            const downsampled = downsampleBuffer(inputData, audioContext.sampleRate, TARGET_SAMPLE_RATE);
            
            // Convert to PCM 16-bit
            const pcm16 = floatTo16BitPCM(downsampled);
            const base64 = arrayBufferToBase64(pcm16);

            const msg = {
                realtime_input: {
                    media_chunks: [{
                        mime_type: "audio/pcm",
                        data: base64
                    }]
                }
            };

            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(msg));
                animateVisualizer(true);
            }
        };
    }

    // --- Audio Utilities ---

    // Simple Downsampler (Linear Interpolation)
    function downsampleBuffer(buffer, sampleRate, outSampleRate) {
        if (outSampleRate === sampleRate) {
            return buffer;
        }
        if (outSampleRate > sampleRate) {
            return buffer; // Upsampling not supported here
        }
        const sampleRateRatio = sampleRate / outSampleRate;
        const newLength = Math.round(buffer.length / sampleRateRatio);
        const result = new Float32Array(newLength);
        let offsetResult = 0;
        let offsetBuffer = 0;
        while (offsetResult < result.length) {
            const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
            let accum = 0, count = 0;
            for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                accum += buffer[i];
                count++;
            }
            result[offsetResult] = accum / count;
            offsetResult++;
            offsetBuffer = nextOffsetBuffer;
        }
        return result;
    }

    function floatTo16BitPCM(input) {
        const output = new Int16Array(input.length);
        for (let i = 0; i < input.length; i++) {
            const s = Math.max(-1, Math.min(1, input[i]));
            output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return output.buffer;
    }

    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    function playPcmData(base64) {
        // Convert Base64 to Float32
        const binary = window.atob(base64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
        const int16 = new Int16Array(bytes.buffer);
        const float32 = new Float32Array(int16.length);
        for(let i=0; i<int16.length; i++) float32[i] = int16[i] / 32768.0;

        // Play
        const buffer = audioContext.createBuffer(1, float32.length, TARGET_SAMPLE_RATE);
        buffer.getChannelData(0).set(float32);
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);
        animateVisualizer(false);
    }

    // --- UI Logic ---

    function setStatus(state) {
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        const panel = document.getElementById('setupPanel');
        const controls = document.getElementById('controlPanel');
        const icon = document.getElementById('mainIcon');
        const ring = document.getElementById('pulseRing');

        if(state === 'connecting') {
            dot.className = "w-3 h-3 rounded-full bg-yellow-500 animate-pulse";
            text.innerText = "جاري الاتصال...";
        } else if(state === 'connected') {
            isConnected = true;
            dot.className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
            text.innerText = "متصل (Google Gemini)";
            panel.classList.add('hidden');
            controls.classList.remove('hidden');
            controls.classList.add('grid');
            icon.classList.add('text-indigo-400');
            ring.classList.remove('opacity-0');
            ring.classList.add('animate-ping');
        } else {
            isConnected = false;
            dot.className = "w-3 h-3 rounded-full bg-red-500";
            text.innerText = "غير متصل";
            panel.classList.remove('hidden');
            controls.classList.add('hidden');
            controls.classList.remove('grid');
            icon.classList.remove('text-indigo-400');
            ring.classList.add('opacity-0');
            ring.classList.remove('animate-ping');
        }
    }

    function disconnect() {
        if(ws) ws.close();
        if(stream) stream.getTracks().forEach(t => t.stop());
        if(audioContext) audioContext.close();
        setStatus('disconnected');
    }

    function showError(msg) {
        document.getElementById('errorLog').innerText = msg;
    }

    function animateVisualizer(isInput) {
        bars.forEach(bar => {
            const h = Math.random() * 100;
            bar.style.height = `${h}%`;
            bar.style.background = isInput ? '#4f46e5' : '#a855f7';
        });
        setTimeout(() => {
            bars.forEach(bar => bar.style.height = '10%');
        }, 200);
    }
</script>

</body>
</html>