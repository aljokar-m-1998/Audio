<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Context Tales | Live Audio Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #020617; color: white; overflow: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .visualizer-bar { transition: height 0.05s; width: 6px; background: #818cf8; border-radius: 99px; }
        .glow-text { text-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Navbar -->
    <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/50 backdrop-blur-md fixed top-0 w-full z-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/30">
                <i data-lucide="mic-2" class="text-white w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-lg tracking-wide">Context Tales <span class="text-indigo-400 text-xs font-light px-2 py-0.5 bg-indigo-500/10 rounded-full border border-indigo-500/20">LIVE 2.5</span></h1>
        </div>
        <div class="flex items-center gap-2">
            <div id="connectionStatus" class="w-3 h-3 rounded-full bg-red-500 transition-colors shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
        </div>
    </header>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col pt-16 pb-32 max-w-3xl mx-auto w-full px-4">
        <div id="chatContainer" class="flex-1 overflow-y-auto py-6 space-y-6">
            <!-- Messages will appear here -->
            <div class="flex flex-col items-center justify-center h-full text-slate-500 space-y-4" id="welcomeMsg">
                <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center animate-pulse">
                    <i data-lucide="waves" class="w-10 h-10 opacity-50"></i>
                </div>
                <p>اضغط على زر الاتصال لبدء المحادثة الحية</p>
            </div>
        </div>
    </main>

    <!-- Bottom Controls -->
    <div class="fixed bottom-0 left-0 w-full bg-slate-900/90 backdrop-blur-xl border-t border-slate-800 p-6 z-50">
        <div class="max-w-md mx-auto w-full space-y-4">
            
            <!-- Setup UI (API Key) -->
            <div id="setupUI" class="flex gap-2">
                <input type="password" id="apiKey" placeholder="ضع مفتاح API هنا..." class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:border-indigo-500 outline-none transition-all">
                <button onclick="toggleConnection()" id="connectBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg shadow-indigo-600/20 whitespace-nowrap">
                    اتصال
                </button>
            </div>

            <!-- Active Call UI (Hidden) -->
            <div id="activeUI" class="hidden flex-col items-center space-y-4">
                <!-- Visualizer -->
                <div class="h-12 flex items-center justify-center gap-1 w-full" id="visualizer">
                    <!-- Bars generated by JS -->
                </div>
                
                <div class="flex items-center gap-6">
                    <button onclick="toggleMic()" id="micBtn" class="w-14 h-14 rounded-full bg-red-500 hover:bg-red-400 text-white flex items-center justify-center shadow-lg transition-all scale-100 active:scale-95">
                        <i data-lucide="mic-off" class="w-6 h-6"></i>
                    </button>
                    <button onclick="disconnect()" class="w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 text-red-400 border border-red-500/30 flex items-center justify-center transition-all">
                        <i data-lucide="phone-off" class="w-5 h-5"></i>
                    </button>
                </div>
                <p class="text-xs text-slate-400 font-mono" id="statusText">متصل: نموذج Gemini 2.5 Flash</p>
            </div>

        </div>
    </div>

    <script>
        lucide.createIcons();
        const chatContainer = document.getElementById('chatContainer');
        const visualizer = document.getElementById('visualizer');
        
        // Generate Visualizer Bars
        for(let i=0; i<30; i++) {
            const bar = document.createElement('div');
            bar.className = 'visualizer-bar h-1';
            visualizer.appendChild(bar);
        }
        const bars = document.querySelectorAll('.visualizer-bar');

        // --- GLOBAL CONFIG ---
        // NOTE: This sample rate (24000) is critical for Gemini Live. Do not change.
        const TARGET_SAMPLE_RATE = 24000; 
        const MODEL_NAME = "models/gemini-2.5-flash-native-audio-dialog"; 

        let audioContext;
        let ws;
        let stream;
        let processor;
        let inputSource;
        let isConnected = false;
        let isMicOn = true;
        let currentAiResponse = "";

        async function toggleConnection() {
            if(isConnected) {
                disconnect();
            } else {
                const key = document.getElementById('apiKey').value;
                if(!key) { alert("الرجاء إدخال المفتاح"); return; }
                connect(key);
            }
        }

        async function connect(key) {
            const btn = document.getElementById('connectBtn');
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i>`;
            
            try {
                // 1. Setup Audio Context
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: TARGET_SAMPLE_RATE });
                
                // 2. Get Mic
                stream = await navigator.mediaDevices.getUserMedia({ audio: { channelCount: 1, sampleRate: TARGET_SAMPLE_RATE } });

                // 3. WebSocket
                const url = `wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${key}`;
                ws = new WebSocket(url);

                ws.onopen = () => {
                    isConnected = true;
                    updateUIState(true);
                    
                    // Send Setup
                    const setupMsg = {
                        setup: {
                            model: MODEL_NAME,
                            generation_config: { response_modalities: ["AUDIO", "TEXT"] } // Request Text & Audio
                        }
                    };
                    ws.send(JSON.stringify(setupMsg));
                    
                    startAudioProcessing();
                    addSystemMessage("تم الاتصال بنجاح. يمكنك التحدث الآن.");
                };

                ws.onmessage = async (evt) => {
                    if (evt.data instanceof Blob) {
                        // Received Audio
                        const arrayBuffer = await evt.data.arrayBuffer();
                        playAudioChunk(arrayBuffer);
                    } else {
                        // Received Control/Text
                        const msg = JSON.parse(evt.data);
                        if (msg.serverContent?.modelTurn?.parts) {
                            msg.serverContent.modelTurn.parts.forEach(p => {
                                if (p.inlineData) {
                                    playPcm(p.inlineData.data);
                                }
                                if (p.text) {
                                    // Sometimes text comes in chunks, we could accumulate it
                                    // For simplicity, we just log it or show it
                                    // appendToLastMessage(p.text);
                                }
                            });
                        }
                    }
                };

                ws.onclose = (e) => {
                    console.log("Close Code:", e.code);
                    disconnect();
                    if(e.code !== 1000 && e.code !== 1005) {
                        addSystemMessage("انقطع الاتصال. (تأكد من المفتاح أو اسم الموديل)", true);
                    }
                };

                ws.onerror = (e) => {
                    console.error(e);
                    disconnect();
                    addSystemMessage("خطأ في الشبكة.", true);
                };

            } catch (err) {
                console.error(err);
                disconnect();
                alert("فشل الوصول للمايكروفون. تأكد من استخدام HTTPS أو Localhost.");
            }
        }

        function disconnect() {
            if(ws) ws.close();
            if(stream) stream.getTracks().forEach(t => t.stop());
            if(audioContext) audioContext.close();
            if(processor) processor.disconnect();
            
            isConnected = false;
            updateUIState(false);
            addSystemMessage("انتهت المحادثة.");
        }

        // --- AUDIO PROCESSING (THE FIX) ---
        function startAudioProcessing() {
            inputSource = audioContext.createMediaStreamSource(stream);
            processor = audioContext.createScriptProcessor(4096, 1, 1);
            inputSource.connect(processor);
            processor.connect(audioContext.destination);

            processor.onaudioprocess = (e) => {
                if (!isConnected || !isMicOn) return;

                const inputData = e.inputBuffer.getChannelData(0);
                
                // Downsample to 24kHz (Critical for Gemini Live)
                const downsampled = downsampleBuffer(inputData, audioContext.sampleRate, TARGET_SAMPLE_RATE);
                const pcm16 = floatTo16BitPCM(downsampled);
                const base64 = arrayBufferToBase64(pcm16);

                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        realtime_input: {
                            media_chunks: [{ mime_type: "audio/pcm", data: base64 }]
                        }
                    }));
                    animateVisualizer(true);
                }
            };
        }

        // --- HELPERS ---
        function downsampleBuffer(buffer, sampleRate, outSampleRate) {
            if (outSampleRate === sampleRate) return buffer;
            if (outSampleRate > sampleRate) return buffer;
            const sampleRateRatio = sampleRate / outSampleRate;
            const newLength = Math.round(buffer.length / sampleRateRatio);
            const result = new Float32Array(newLength);
            let offsetResult = 0;
            let offsetBuffer = 0;
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                let accum = 0, count = 0;
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result;
        }

        function floatTo16BitPCM(input) {
            const output = new Int16Array(input.length);
            for (let i = 0; i < input.length; i++) {
                const s = Math.max(-1, Math.min(1, input[i]));
                output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return output.buffer;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
            return window.btoa(binary);
        }

        function playPcm(base64) {
            const binary = window.atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            const int16 = new Int16Array(bytes.buffer);
            const float32 = new Float32Array(int16.length);
            for(let i=0; i<int16.length; i++) float32[i] = int16[i] / 32768.0;
            
            const buffer = audioContext.createBuffer(1, float32.length, TARGET_SAMPLE_RATE);
            buffer.getChannelData(0).set(float32);
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);
            animateVisualizer(false);
        }

        // --- UI LOGIC ---
        function updateUIState(active) {
            const connectBtn = document.getElementById('connectBtn');
            const setupUI = document.getElementById('setupUI');
            const activeUI = document.getElementById('activeUI');
            const statusDot = document.getElementById('connectionStatus');
            const welcomeMsg = document.getElementById('welcomeMsg');

            if(active) {
                setupUI.classList.add('hidden');
                activeUI.classList.remove('hidden');
                activeUI.classList.add('flex');
                welcomeMsg.classList.add('hidden');
                statusDot.classList.replace('bg-red-500', 'bg-green-500');
                statusDot.classList.add('shadow-green-500/50');
            } else {
                setupUI.classList.remove('hidden');
                activeUI.classList.add('hidden');
                activeUI.classList.remove('flex');
                welcomeMsg.classList.remove('hidden');
                connectBtn.innerHTML = "اتصال";
                statusDot.classList.replace('bg-green-500', 'bg-red-500');
                statusDot.classList.remove('shadow-green-500/50');
            }
        }

        function toggleMic() {
            isMicOn = !isMicOn;
            const btn = document.getElementById('micBtn');
            if(isMicOn) {
                btn.classList.replace('bg-red-500', 'bg-white');
                btn.classList.replace('text-white', 'text-indigo-600');
                btn.innerHTML = `<i data-lucide="mic" class="w-6 h-6"></i>`;
            } else {
                btn.classList.replace('bg-white', 'bg-red-500');
                btn.classList.replace('text-indigo-600', 'text-white');
                btn.innerHTML = `<i data-lucide="mic-off" class="w-6 h-6"></i>`;
            }
            lucide.createIcons();
        }

        function addSystemMessage(text, isError = false) {
            const div = document.createElement('div');
            div.className = `p-3 rounded-lg text-sm text-center ${isError ? 'bg-red-500/10 text-red-400' : 'bg-slate-800 text-slate-300'}`;
            div.innerText = text;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function animateVisualizer(isInput) {
            bars.forEach(bar => {
                const h = Math.random() * 30 + 10; // Min height 10px
                bar.style.height = `${h}px`;
                bar.style.backgroundColor = isInput ? '#818cf8' : '#c084fc';
            });
            setTimeout(() => {
                bars.forEach(bar => bar.style.height = '4px');
            }, 100);
        }
    </script>
</body>
</html>